#!/bin/bash

set -e

TMP_INSERTABLE_VARS_LIST=""

function register_insertable_env_var {
	local VAR_NAME="$1"
	if [ -z "${!VAR_NAME}" ]; then
		echo "Environment variable $VAR_NAME is not set. Exiting."
		exit 1
	fi
	if [ -n "$TMP_INSERTABLE_VARS_LIST" ]; then
		TMP_INSERTABLE_VARS_LIST="$TMP_INSERTABLE_VARS_LIST $VAR_NAME"
	else
		TMP_INSERTABLE_VARS_LIST="$VAR_NAME"
	fi
}

function replace_insertable_vars_in_all_config_files {
    local config_dir="./config"
    
    # Check if config directory exists
    if [[ ! -d "$config_dir" ]]; then
        echo "Error: Config directory '$config_dir' does not exist." >&2
        return 1
    fi
    
    # Check if there are any variables to replace
    if [[ -z "$TMP_INSERTABLE_VARS_LIST" ]]; then
        echo "Warning: No variables to replace." >&2
        return 0
    fi
    
    # Loop through each variable
    for VAR_NAME in $TMP_INSERTABLE_VARS_LIST; do
        # Check if variable is set
        if [[ -z "${!VAR_NAME}" ]]; then
            echo "Warning: Variable '$VAR_NAME' is not set or is empty." >&2
            continue
        fi
        
        # Find files containing the placeholder
        local files
        files=$(grep -rl "{{${VAR_NAME}}}" "$config_dir" 2>/dev/null)
        
        if [[ -n "$files" ]]; then
            # Escape slashes in the value for sed
            local value
            value="${!VAR_NAME}"
            value="${value//\//\\/}"  # Escape forward slashes
            value="${value//&/\\&}"   # Escape ampersands
            
            # Replace in all found files
            echo "$files" | xargs sed -i "s/{{${VAR_NAME}}}/${value}/g"
        fi
    done
}


# Set insertable variables
INSERT_TARGET_DATE=$(date +%Y%m%d)

register_insertable_env_var INSERT_TARGET_DATE
register_insertable_env_var INSERT_TARGET_ARCH
register_insertable_env_var INSERT_TARGET_LIVE_VERSION
register_insertable_env_var INSERT_BASE_CODENAME

# Replace insertable variables in config files
replace_insertable_vars_in_all_config_files

# Prepare hooks
mkdir -p config/hooks/normal/
cp ./config/hooks/*.hook.chroot config/hooks/normal/
chmod +x config/hooks/normal/*.hook.chroot

lb config noauto \
	--clean \
	\
	--architectures "$INSERT_TARGET_ARCH" \
	\
	--distribution "$INSERT_BASE_CODENAME" \
	--mirror-binary "https://deb.debian.org/debian" \
	--mirror-bootstrap "https://deb.debian.org/debian" \
	--archive-areas "main contrib non-free non-free-firmware" \
	--backports true \
	--security true \
	--updates true \
	--source false \
	--firmware-binary true \
	--firmware-chroot true \
	--linux-packages "linux-image linux-headers" \
	\
	--binary-filesystem ext4 \
	--binary-images iso-hybrid \
	--checksums sha256 \
	--debconf-frontend noninteractive \
	--debootstrap-options "--include=apt-transport-https,ca-certificates,openssl" \
	\
	--bootloaders "grub-pc grub-efi" \
	--bootappend-live "boot=live components quiet username=user hostname=leios" \
	--initramfs live-boot \
	--memtest memtest86+ \
	\
	--iso-publisher LeiCraft_MC \
	--iso-application "LeiOS Live $INSERT_TARGET_LIVE_VERSION $INSERT_TARGET_ARCH" \
	--iso-volume "LeiOS Live $INSERT_TARGET_LIVE_VERSION $INSERT_TARGET_ARCH" \
	--image-name leios-$INSERT_TARGET_LIVE_VERSION \

"${@}"
