#!/bin/sh

set -e

TMP_INSERTABLE_VARS_LIST=""

register_insertable_env_var() {
    eval "value=\${$1}"
    if [ -z "$value" ]; then
        echo "Environment variable $1 is not set. Exiting."
        exit 1
    fi
    TMP_INSERTABLE_VARS_LIST="${TMP_INSERTABLE_VARS_LIST:+$TMP_INSERTABLE_VARS_LIST }$1"
}

replace_insertable_vars_in_all_config_files() {
    [ ! -d "./config" ] && return 0
    
    for var in $TMP_INSERTABLE_VARS_LIST; do
        eval "value=\${$var}"
        [ -z "$value" ] && continue
        
        # Use awk for safe replacement
        find ./config -type f -exec grep -l "{{${var}}}" {} \; 2>/dev/null |
        while read -r file; do
            awk -v placeholder="{{${var}}}" -v replacement="$value" '
                {gsub(placeholder, replacement); print}
            ' "$file" > "${file}.tmp" && mv "${file}.tmp" "$file"
        done
    done
}

BOOTLOADERS_CONFIG=""

# handle diffrent architectures
if [ "$INSERT_TARGET_ARCH" = "amd64" ]; then

	rm -f config/package-lists/arch-arm64.list.chroot

	BOOTLOADERS_CONFIG="grub-pc grub-efi"

elif [ "$INSERT_TARGET_ARCH" = "arm64" ]; then
	rm -f config/package-lists/arch-amd64.list.chroot

	BOOTLOADERS_CONFIG="grub-efi"
else 
	echo "Unsupported architecture: $INSERT_TARGET_ARCH"
	exit 1
fi

# Set insertable variables
INSERT_TARGET_DATE=$(date +%Y%m%d)


# Set insertable variables
INSERT_TARGET_DATE=$(date +%Y%m%d)

register_insertable_env_var INSERT_TARGET_DATE
register_insertable_env_var INSERT_TARGET_ARCH
register_insertable_env_var INSERT_TARGET_LIVE_VERSION
register_insertable_env_var INSERT_BASE_CODENAME

# Replace insertable variables in config files
replace_insertable_vars_in_all_config_files

# Prepare hooks
mkdir -p config/hooks/normal/
cp ./config/hooks/*.hook.chroot config/hooks/normal/
chmod +x config/hooks/normal/*.hook.chroot

lb config noauto \
	--clean \
	\
	--architectures "$INSERT_TARGET_ARCH" \
	\
	--distribution "$INSERT_BASE_CODENAME" \
	--mirror-binary "https://deb.debian.org/debian" \
	--mirror-bootstrap "https://deb.debian.org/debian" \
	--archive-areas "main contrib non-free non-free-firmware" \
	--backports true \
	--security true \
	--updates true \
	--source false \
	--firmware-binary true \
	--firmware-chroot true \
	--linux-packages "linux-image linux-headers" \
	\
	--binary-filesystem ext4 \
	--binary-images iso-hybrid \
	--checksums sha256 \
	--debconf-frontend noninteractive \
	--debootstrap-options "--include=apt-transport-https,ca-certificates,openssl" \
	\
	--bootloaders "$BOOTLOADERS_CONFIG" \
	--bootappend-live "boot=live components quiet username=user hostname=leios" \
	--initramfs live-boot \
	--memtest memtest86+ \
	\
	--iso-publisher LeiCraft_MC \
	--iso-application "LeiOS Live $INSERT_TARGET_LIVE_VERSION $INSERT_TARGET_ARCH" \
	--iso-volume "LeiOS Live $INSERT_TARGET_LIVE_VERSION $INSERT_TARGET_ARCH" \
	--image-name leios-live-$INSERT_TARGET_LIVE_VERSION \

"${@}"
